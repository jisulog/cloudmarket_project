{% extends "base.html" %}
{% block content %}

<!-- 게시글 -->
<div class="container">
<h3>{{ post.post_title }}</h3>
{{ post.user_id.last_name }} | {% if post.modify_date %} {{ post.modify_date }}(수정) {% else %} {{ post.create_date }} {% endif %}
<div>
    {% if post.image %}
    <img src="{{ post.image.url }}" alt="{{ post.image }}">
    <!--resize height="300" width="500"-->
    {% else %}
    <p>이미지가 없습니다</p>
    {% endif %}
    <p>{{ post.content }}</p>
    <p>{{ post.price }}원</p>
</div>

<div>
    {% if request.user == post.user_id %}
    <a href="{% url 'market:postupdate' post.id  %}">수정</a>
    <a href="{% url 'market:postdelete' post.id  %}">삭제</a>
    {% endif %}
</div>
</div>

<!-- 댓글 목록 -->
<hr>
<h5>{{ post.comment_set.count }}개의 답변이 있습니다.</h5>
<div></div>

<!-- 댓글 수정 -->
{% for comment in post.comment_set.all %}
<div class="mt-3">
    <div class="comment py-2 text-muted" id="divToggle1{{ comment.id }}" style="display: block;">
        <span style="white-space: pre-line;">
    {{ comment.user_id }} | {% if comment.modify_date %} {{ comment.modify_date }}(수정) {% else %} {{ comment.create_date }} {% endif %}<br></span>
    <span>{{ comment.content }}</span><br>
    {% if request.user == comment.user_id %}
    <input type="button" class="btn btn-primary" value="수정" id="button1{{ comment.id }}">
    <a class="btn btn-primary" href="{% url 'market:commentdelete' comment.id  %}">삭제</a>
    </div>
    <div class="comment py-2 text-muted" id="divToggle2{{ comment.id }}" style="display: none;">
    <form method="post" class="post-form my-3" action="{% url 'market:commentupdate' comment.pk %}">
        {% csrf_token %}
        {{ form.as_p }}
        <input type="submit" class="btn btn-primary" value="저장">
        <input type="button" class="btn btn-primary" value="이전" id="button2{{ comment.id }}">
    </form>
    </div>
    {% endif %}
    <hr>
</div>
{% endfor %}


<!-- 댓글 작성 -->
<form action="{% url 'market:commentcreate' post.id  %}" method="post" {% if not user.is_authenticated %}hidden{% endif %}>
    {% csrf_token %}
    {% include "form_errors.html" %}
    <textarea name="content" id="content" rows="2" cols="30" value="{{ form.username.value|default_if_none:'' }}"required></textarea><br>
    <input type="submit" class="btn btn-primary" name='create' id='create' value="등록">
</form>

<!-- 검색 폼  -->
<form id="searchForm" method="get" action="{% url 'market:postlist' %}">
    <input type="hidden" id="kw" name="kw" value="{{ kw|default_if_none:'' }}">
    <input type="hidden" id="page" name="page" value="{{ page }}">
</form>

{% endblock %}
{% block script %}
<script type='text/javascript'>
    //console.log('자바스크립트 초입');
    //document.write('자바스크립트 초입');
    $(document).ready(function () {
        $(".page-link").on('click', function () {
            $("#page").val($(this).data("page"));
            $("#searchForm").submit();
        });

        $("#btn_search").on('click', function () {
            //console.log('버튼 입력');
            //document.write('버튼 입력');
            $("#kw").val($(".kw").val());
            $("#page").val(1);  // 검색버튼을 클릭할 경우 1페이지부터 조회한다.
            $("#searchForm").submit();
        });
    });
    // 댓글
    $('div').each(function(index, value) {
        console.log(`div${index}: ${this.id}`);
    });
    $(document).ready(function (){ $("[id^=button1]").click(
        function (e){ 
            var target = $(e.target);
            target.parent().toggle();
            target.parent().next().toggle();
            // $("[id^=divToggle2]").toggle(); 
            // $("[id^=divToggle1]").toggle(); 
        }); 
    });
    $(document).ready(function (){ $("[id^=button2]").click(
        function (e){    
            var target = $(e.target);
            target.parent().toggle();
            target.parent().parent().prev().toggle();
            // $("[id^=divToggle1]").toggle();
            // $("[id^=divToggle2]").toggle(); 
        });
    });

    console.log("[id^=button1]")
</script>
{% endblock %}